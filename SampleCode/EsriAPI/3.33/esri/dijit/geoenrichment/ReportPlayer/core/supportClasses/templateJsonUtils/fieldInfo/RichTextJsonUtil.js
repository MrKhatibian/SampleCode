// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/RichTextJsonUtil",["./utils","esri/dijit/geoenrichment/ReportPlayer/countryConfig"],function(h,m){var f={_wrapFieldInfoInRichText:function(a){return"["+a.name+"]"},_updateXMLString:function(a,b,d){return a.replace(new RegExp("\\["+b+"\\]","g"),d)},isDTagFieldInfo:function(a){return a&&(a.hasVariable||a.script||0===a.name.indexOf("headers."))}},n=/<d.*?\/>/,p=/<text.*?\/>/,k=/<reportname.*?\/>/i,l=/<reporttitle2.*?\/>/i;
f.createFieldInfoFromRichText=function(a,b){a=a||"";b=b||[];var d={};for(i=0;i<b.length;i++){var c=b[i],e;e="Title"===c.name&&k.test(a)?k:"Subtitle"===c.name&&l.test(a)?l:f.isDTagFieldInfo(c)?n:p;a=a.replace(e,f._wrapFieldInfoInRichText(c));d[c.name]=c}return{isRichText:!0,richTextJson:{fieldInfos:d,xmlString:a}}};f.createRichTextFromFieldInfo=function(a,b){a=a.richTextJson;var d=a.xmlString,c;for(c in a.fieldInfos)var e=a.fieldInfos[c],g=b(e),d=f._updateXMLString(d,e.name,g||"");return d};f.updateXMLString=
function(a,b){b.forEach(function(b){a.richTextJson.xmlString=f._updateXMLString(a.richTextJson.xmlString,b.nameBefore,"["+b.name+"]")})};f.addFieldInfosToRichTextFieldInfo=function(a,b,d){d=d||{};var c=a.richTextJson;a=b.map(function(a){c.fieldInfos[a.name]=a;return d.insertRendered?h.renderer.renderFieldInfoInTableCell(a).formattedValue:f._wrapFieldInfoInRichText(a)}).join(", ");var e=c.xmlString,g="number"===typeof d.insertIndex?Math.min(e.length,d.insertIndex):e.length;b=e.substr(0,g);e=e.substr(g);
d.addSpaces&&b.length&&" "!==b.charAt(b.length-1)&&(b+=" ");d.addSpaces&&e.length&&!/^(\s|\.|,|:|\))/.test(e)&&(e=" "+e);c.xmlString=b+a+e};f.replaceFieldInfoInRichTextFieldInfo=function(a,b,d){var c=a.richTextJson;c.fieldInfos[b.name]&&-1!==c.xmlString.indexOf(f._wrapFieldInfoInRichText(b))&&(delete c.fieldInfos[b.name],f.updateXMLString(a,[{nameBefore:b.name,name:d.name}]),c.fieldInfos[d.name]=d)};var q={_reCache:{},getRegExp:function(){var a=m.getCurrencySymbol();this._reCache[a]||(this._reCache[a]=
new RegExp("[\\"+a+"%]*\\[.+?\\]%*","g"));return this._reCache[a]}};f.createFieldInfoFromRenderedXMLString=function(a,b){a=f.collectFieldInfosFromRenderedXMLString(a,b);return f.createFieldInfoFromRichText(a._xmlString,a.fieldInfos)};f.collectFieldInfosFromRenderedXMLString=function(a,b){var d={};if(b)for(var c in b.fieldInfos){var e=b.fieldInfos[c];d[h.renderer.renderFieldInfoInTableCell(e).formattedValue]=e}var g=[];(b=a.match(q.getRegExp()))&&b.forEach(function(b){var c=d[b]||h.builder.createFieldInfoFromSpecialFieldName(b.replace(/\[|\]/g,
""))||h.builder.createFieldInfoFromLabel(b);c&&(g.push(c),a=a.replace(b,f.isDTagFieldInfo(c)?"\x3cd/\x3e":"\x3ctext/\x3e"))});return{fieldInfos:g,_xmlString:a}};return f});