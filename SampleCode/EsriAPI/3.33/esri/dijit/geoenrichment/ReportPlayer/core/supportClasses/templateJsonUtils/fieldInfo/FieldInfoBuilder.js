// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoBuilder",["./utils","dojo/i18n!esri/nls/jsapi"],function(d,h){function l(a){Object.keys(a).forEach(function(c){var b=a[c];void 0!==b&&null!==b||delete a[c]})}h=h.geoenrichment.dijit.ReportPlayer.ReportPlayer;var g={NUMBER:"n/",createFieldInfoFromCalculator:function(a,c,b){if(!a)return null;a=(c="function"===typeof a.getDescriptionWithType?a:null)?c.variable:a;var f=b&&b.format,e=b&&b.autoformatCurrency,
g=b&&b.additionalText,h=b&&b.calculatorName,k=b&&b.defaultDistanceUnits;b=b&&b.summaryType;var m=c&&c.getToggleGroup&&c.getToggleGroup();b={alias:c?c.getDescriptionWithType()||c.getAliasWithType():a.description||a.alias,hasVariable:!0,variableID:a.id,fullName:a.fullName,fieldCategory:a.fieldCategory,vintage:a.vintage,type:a.type,statefulName:m?m.value:"n/"+a.fullName,summaryType:b};c=c?c.getCalcType().charAt(0):"n";b.name=d.name.createFieldNameFromSource(a,c);f?d.format.setFieldInfoFormat(b,f):(b.decimals=
a.precision,b.showCurrency=!(!e||"n"!==c||!a.units||"CURRENCY"!==a.units.toUpperCase()),b.showPercent=!b.showCurrency&&("p"===c||"n"===c&&a.units&&"PCT"===a.units.toUpperCase()),b.useThousandsSeparator=!0);a.isWebMap&&(b.isWebMap=!0,b.webMapFieldName=a.fieldName,b.webMapField=a.field,b.webMapId=a.webMapId,b.layerUrl=a.layerUrl,!f&&a.fieldInfo&&a.fieldInfo.format&&(b.decimals=a.fieldInfo.format.places,b.useThousandsSeparator=!1!==a.fieldInfo.format.digitSeparator));a.customDataCollection&&(b.isCustomDataCollection=
!0,b.customDataCollectionId=a.customDataCollection.id,b.customDataCollectionUrl=a.customDataCollection.url,b.customDataCollectionPortalUrl=a.customDataCollection.portalUrl);a.isSiteAttribute&&(b.isSiteAttribute=!0,b.attribute=a.attribute,b.type=a.attribute.type,!f&&0<a.attribute.places&&(b.decimals=a.attribute.places));a.isDataLayerAttribute&&(b.isDataLayerAttribute=!0,b.layerID=a.layerID,b.layerUrl=a.layerUrl,b.layerName=a.layerName,b.attribute=a.attribute,b.type=a.attribute.type,!f&&0<a.attribute.decimals&&
(b.decimals=a.attribute.decimals),"DISTANCE"===a.attribute.name&&(b.units=a.attribute.units||k||"esriMiles"));"string"===typeof g&&(b.additionalText=g);b.usedFields=a.usedFields;b.expressionText=a.expressionText;d.name.provideQualifiedFieldInfoTemplateName(b,h);l(b);return b},fieldInfoToVariable:function(a){if(!a.hasVariable)return null;var c={id:a.variableID,fullName:a.fullName,fieldCategory:a.fieldCategory,vintage:a.vintage,type:a.type,precision:a.decimals,usedFields:a.usedFields,expressionText:a.expressionText};
a.isWebMap&&(c.isWebMap=!0,c.fieldName=a.webMapFieldName,c.field=a.webMapField,c.webMapId=a.webMapId,c.layerUrl=a.layerUrl);a.isSiteAttribute&&(c.isSiteAttribute=!0,c.attribute=a.attribute);return c},createFieldInfoFromScript:function(a,c){var b=c&&c.format,f=c&&c.additionalText;c=c&&c.calculatorName;a=a||{};a.name=a.name||d.name.DEFAULT_SCRIPT_NAME;a.alias=a.alias||h.scriptNameDefault;a.decimals=Number(a.decimals)||0;var e={};e.name=d.name.createFieldNameFromScript(a);d.name.provideQualifiedFieldInfoTemplateName(e,
c);e.script=a;b?d.format.setFieldInfoFormat(e,b):(e.decimals=Number(a.decimals),e.showCurrency=!1,e.showPercent=!1,e.useThousandsSeparator=!0);"string"===typeof f&&(e.additionalText=f);l(e);return e},createFieldInfoFromImage:function(a,c){return{isImage:!0,imageJson:a,triggerJson:c}},createFieldInfoFromMap:function(a){return{isMap:!0,mapJson:a}},createFieldInfoFromShape:function(a){return{isShape:!0,shapeJson:a}},createFieldInfoFromChart:function(a){return{isChart:!0,chartJson:a}},createFieldInfoFromInfographic:function(a){return{isInfographic:!0,
infographicJson:a}},createFieldInfoFromSection:function(a){return{isReportSection:!0,sectionJson:a}},createFieldInfoFromMissingVariable:function(a,c){return{name:a&&a.substr(a.indexOf(".")+1),templateName:a,isMissing:!0,alias:c}},createFieldInfoForUnsupportedContent:function(){return{isUnsupportedContent:!0}}},k=/^\[\w+\]$/,n=/\[\w+\]/;g.createFieldInfoFromLabel=function(a,c){if("string"!==typeof a)return null;a=a.trim();var b=k.test(a);if(!c||b){if(!b)return null;a=a.replace(/\[|\]/g,"").toUpperCase();
return g.createFieldInfoFromSpecialFieldName(d.fields.uiToTemplate(a))}return n.test(a)?d.richText.createFieldInfoFromRenderedXMLString(a):null};g.createFieldInfoFromSpecialFieldName=function(a,c){if("string"!==typeof a)return null;var b;a=d.fields.trimTemplateHeaderName(a);a=a.toUpperCase();"GROUPCOUNT"===a?b={name:d.fields.GROUPCOUNT_FIELD_NAME,alias:d.fields.GROUPCOUNT_FIELD_ALIAS}:"CURRDATE"===a?b={name:d.fields.DATE_FIELD_NAME,alias:d.fields.DATE_FIELD_ALIAS,format:c||d.fields.DATE_FIELD_DEFAULT_FORMAT}:
"SITENOTES"===a?b={name:d.fields.qualifyTemplateHeaderName(d.fields.SITENOTES_FIELD_NAME),alias:d.fields.SITENOTES_FIELD_ALIAS,type:"esriFieldTypeString"}:0===a.indexOf("SITENOTE")&&(b=d.fields.getSiteNoteFieldNameAt(a.replace("SITENOTE","")),b={name:d.fields.qualifyTemplateHeaderName(b),alias:b,type:"esriFieldTypeString"});if(b)return b;var f=d.fields.templateToUIHeader(a);f?(b={name:d.fields.qualifyTemplateHeaderName(a),alias:f,type:"esriFieldTypeString"},d.fields.isChartAttribute(a)&&(b.isChartAttribute=
!0),"CHART_POINT_VALUE"===a&&(b.type="esriFieldTypeDouble",b.decimals=0,b.useThousandsSeparator=!0,c&&d.format.setFieldInfoFormat(b,c))):(c=d.fields.templateToUIReportVar(a))&&(b={name:c,alias:c,type:"esriFieldTypeString"});b&&(b.templateName=b.name);return b};var p=/_P$/i;g.isFieldInfoInPercentState=function(a){return a?a.statefulName&&("p"===a.statefulName.charAt(0)||p.test(a.statefulName))||a.alias&&-1!==a.alias.indexOf("(%)"):!1};return g});