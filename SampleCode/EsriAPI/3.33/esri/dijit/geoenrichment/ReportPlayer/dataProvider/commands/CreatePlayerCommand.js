// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/commands/CreatePlayerCommand","require dojo/_base/declare esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all ../../PlayerCommands ../supportClasses/GEUtil dojo/i18n!esri/nls/jsapi".split(" "),function(m,n,p,e,q,r,t,f){function u(){if(d)return e(d.promise);d=new p;m(["dijit/Dialog","esri/dijit/geoenrichment/utils/FileUtil","./mapToImage/MapToImageUtil","./supportClasses/DynamicHTMLPageBuilder"],
function(a,c,b,v){g=a;h=c;k=b;l=v;d.resolve();d=!0});return d.promise}f=f.geoenrichment.dijit.ReportPlayer.ReportPlayer;var g,h,k,l,d;return n(null,{id:r.DYNAMIC_HTML,label:f.createDynamicHTMLCommandLabel,errorMessage:f.exportInfographicError,execute:function(a,c){c=c||{};var b=c.printableContainer;c.reportTitle=a.getReportTitle();c.allowDataDrilling=b.allowDataDrilling();c.getImageInfos=function(){return!b.allowFallbackMaps()||c.skipFallbackMaps?null:k.collectMapsAsImages(a,{saveImagesAsDataUrl:!0})};
c.loadStdFeatures=function(){return a._viewModel.loadAllStdFeatures()};c.reportDataToJson=function(b){return a.reportDataToJson({loadDataDrillingData:c.allowDataDrilling,mapImageInfos:b})};return this._execute(c).always(function(a){return e(b.stop(),function(){return a})})},executeOnData:function(a,c,b){b=b||{};b.reportTitle=c.reportObject.title;b.allowDataDrilling=!0;b.reportDataToJson=function(){return a.reportDataToJson(c)};return this._execute(b)},_execute:function(a){a=a||{};var c=this;return u().then(function(){return q({mapImageInfos:a.getImageInfos&&
a.getImageInfos(),stdFeatures:a.loadStdFeatures&&a.loadStdFeatures()}).then(function(b){var d;return e(a.reportDataToJson(b.mapImageInfos),function(b){if(a.returnReportDataJson)d=b;else return e(l.buildHTMLPageString(b,a.reportTitle,a.allowDataDrilling,a.disableExportOptions),function(b){d=b;var e=a.fileName||a.reportTitle+".html";return b&&!a.returnAsHtmlText&&c._confirmSaveFile(e,function(){return h.saveTextFile(b,e,"text/html",{addDownloadIntervals:a.addDownloadIntervals})})})}).then(function(){!a.skipCreditConsumption&&
a.creditsTaskIDs&&a.creditsTaskIDs.forEach(function(a){t.consumeCredits(a)});return d})}).otherwise(c._handleError.bind(c))})},_handleError:function(a){console.log(a);(new g({title:"Error",content:this.errorMessage})).show()},_confirmSaveFile:function(a,c){return c()}})});