// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/TemplateJsonLoader","dojo/_base/lang esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./CustomReportsManager ./GenericTemplateGenerator ./dataCollections/DataCollectionsLoader ../../core/conversion/PortalToEditorConverter ../../core/conversion/portalToEditorUtils/variables/PlayerVariableProvider ../../core/supportClasses/templateJsonUtils/fieldInfo/FieldInfoNameUtil ../../core/conversion/portalToEditorUtils/parsers/_FieldInfoBuilder".split(" "),
function(n,p,l,q,r,t,u,m,h,v){var k={_templatesCache:{},getCachedTemplateJsonPromise:function(a,b){return(a=this._templatesCache[a+";"+b.reportID])&&a.modified===b.modified?a.promise.then(function(a){return{templateJson:n.clone(a.templateJson),templateVariableProvider:a.templateVariableProvider}}):null},putCachedTemplateJsonPromise:function(a,b,e){this._templatesCache[b+";"+e.reportID]={modified:e.modified,promise:a}}};return{getTemplateJsonByID:function(a,b){var e=this,d=new p;l(q.getCustomReportByID(a),
function(c){if(c){var g=b&&k.getCachedTemplateJsonPromise(a.countryID,c);g?g.then(d.resolve,d.reject):(g=e._loadCustomReportData(c).then(function(){var a=new m;return l(u.provideEditorJson(c,{variableProvider:a}),function(){var b=c.templateJson;c.portalJson=null;c.templateJson=null;return{templateJson:b,templateVariableProvider:a}})}),b?(k.putCachedTemplateJsonPromise(g,a.countryID,c),k.getCachedTemplateJsonPromise(a.countryID,c).then(d.resolve,d.reject)):g.then(d.resolve,d.reject))}else d.reject("Can't find a report")},
d.reject);return d.promise},_loadCustomReportData:function(a){a.portalJson=null;return a.templateData.getFiles().then(function(b){a.portalJson={files:b}})},createTemplateJsonFromVariables:function(a){return t.loadVariables({countryID:a.countryID,outFields:["description","precision","type","vintage"],forceLowerCase:!0}).then(function(b){var e=new m,d=b.fullNameToVariableCache;b=a.variables.fullNames.map(function(c){var b=h.createFieldNameFromSource(c),f=a.variables.customDataMapping[c],f=f?f.variable:
d[c];c={id:f.id.toLowerCase(),fullName:c,alias:f.description,fieldName:b,precision:f.precision,calculatorName:h.DATA_COLLECTIONS_CALCULATOR_NAME,templateName:h.DATA_COLLECTIONS_CALCULATOR_NAME+"."+b,type:f.type,vintage:f.vintage};e.addVariable(c);return v.getCalculatorOrScriptFieldInfo(c.templateName,{variableProvider:e})});return{templateJson:r.generateTemplatesFromFieldInfos(b,{comparisonLevels:a.comparisonLevels}),templateVariableProvider:e}})}}});