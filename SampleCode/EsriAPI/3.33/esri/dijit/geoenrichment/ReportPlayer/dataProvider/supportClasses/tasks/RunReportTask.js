// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.33/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/tasks/RunReportTask","dojo/_base/declare dojo/_base/lang esri/dijit/geoenrichment/promise/all esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when ./parsers/DataXMLParser ./EnrichAreasTask ../areas/AnalysisAreaJsonUtil esri/dijit/geoenrichment/utils/ArrayUtil esri/dijit/geoenrichment/ReportPlayer/config esri/dijit/geoenrichment/ReportPlayer/_devConfig".split(" "),function(d,f,n,g,h,p,q,r,t,k,u){var l={_cache:{},_buildKey:function(a){return[a.countryID,
a.hierarchy,JSON.stringify(r.areasToJson(a.analysisAreas,{excludeInfoTemplate:!0})),a.report.reportID,a.report.portalUrl,a.report.modified].join("_")},getCopy:function(a){a=this._buildKey(a);return(a=this._cache[a])&&f.clone(a)},copyAndPut:function(a,c){a=this._buildKey(a);this._cache[a]=c&&f.clone(c)},getResults:function(){var a=[],c;for(c in this._cache)a.push(this._cache[c]);return a}},w={execute:function(a){var c=a.cacheResult&&l.getCopy(a);if(c)return h(c);var c=t.splitArrayToBunches(a.analysisAreas,
10),d;return n(c.map(function(c){function b(){var e=f.mixin({},a,{analysisAreas:c});e.getAttributes=function(v){if(!a.attachmentsStore)return null;if(!a.attachmentsStore.supportsMultipleAreas&&d)return d;a.attachmentsStore.supportsMultipleAreas&&a.attachmentsStore.setCurrentAnalysisAreaIndex(a.analysisAreas.indexOf(v));return h(a.attachmentsStore.getAttributes(),function(a){d=d||a;return a})};return(new q).createReport(e).then(function(a){var e=a&&a.taskID;a=a&&a.result;try{u.emulateErrors.createReportError&&
(a={error:{message:"Error test: something crashed on the server!"}});var b;a&&"object"===typeof a&&(b=a.error);if(!b&&"string"===typeof a&&-1!==a.indexOf("{"))try{var c=JSON.parse(a);b=c&&c.error}catch(m){}if(b)if(k.runReportTask.ignoreErrors)a=[];else return(new g).reject(b);var d=p.parse(a);return{taskID:e,areaData:d.areaData,reportInfo:d.reportInfo,originalXML:a,error:b}}catch(m){return(new g).reject(m)}})}return h(b(),function(a){return!a||a.error?k.runReportTask.secondAttempt?b():a:a},function(a){return k.runReportTask.secondAttempt?
b():(new g).reject(a)})})).then(function(c){var b={taskIDs:[],areaData:[],reportInfo:null,originalXMLs:[],errors:[]};c.forEach(function(a){b.taskIDs.push(a.taskID);b.originalXMLs.push(a.originalXML);a.error&&b.errors.push(a.error);b.areaData=b.areaData.concat(a.areaData);b.reportInfo=a.reportInfo});a.cacheResult&&!b.errors.length&&l.copyAndPut(a,b);return b})}};d=d(null,{execute:function(a){console.log("Creating a new report...");return w.execute(a)}});d.CreateReportResultCache=l;return d});